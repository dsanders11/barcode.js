<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="../dist/w69b.qrcode.js"></script>
    <title>Binarizer Demo</title>
  </head>
  <body>
    <input type="file" id="file"/>
    <canvas id="canvas"></canvas>
    <img id="input_image"/>
    <script type="text/javascript">
      (function() {
        var fileEl, inputImageEl, imageEl, canvasEl, context;

        function onDecoded(result) {
          console.log(result);
        }

        function load() {
          fileEl = document.getElementById('file');
          imageEl = document.getElementById('input_image');
          inputImageEl = document.getElementById('input_image');
          canvasEl = document.getElementById('canvas');
          context = canvasEl.getContext('2d');
          fileEl.addEventListener('change', function() {
            if (fileEl.files.length > 0) {
              inputImageEl.src = URL.createObjectURL(fileEl.files[0]);
            }
          }, false);
          imageEl.onload = function() {
            try {
              var imgData = w69b.imgtools.getImageData(imageEl);
              var binary = w69b.imgtools.binarizeImageData(imgData, 700);
              var drawable = new w69b.ui.CanvasDrawable(canvasEl);
              w69b.imgtools.renderToDrawable(binary, drawable);
              var pendingResult = new w69b.decoding.Decoder(
                {maxSize: 700, worker: false}).decode(imageEl);
              pendingResult.then(function(result) {
                result['patterns'].forEach(function(point, idx) {
                  var size = point.size || 4;
                  context.fillStyle = 'rgba(200,255,50,1)';
                  context.beginPath();
                  context.arc(point.x, point.y, size, 0, 2 * Math.PI, false);
                  context.fill();
                });
                onDecoded(result['text']);
              }, function(err) {
                onDecoded(err);
              });
            } catch (err) {
              onDecoded(err.message);
            }
          };
        }

        load();
      })();
    </script>
  </body>
</html>
